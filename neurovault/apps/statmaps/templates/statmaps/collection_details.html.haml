{% extends "base.html" %}
{% block head %}

<title>{% block title %}NeuroVault: {{collection.name}}{% endblock %}</title>

<script type='text/javascript'>

 function showLoader() {   
    document.getElementById('spinny').style.display = 'block';
    document.getElementById('fade').style.display = 'block';
  }

  function hideLoader() {
    document.getElementById('spinny').style.display = 'none';
    document.getElementById('fade').style.display = 'none';
  }

(function() {
  var uldata;

  uldata = void 0;

  $(document).ready(function() {
    $('#show-viewer').click((function(_this) {
      return function() {
        window.viewer.paint();
        return setTimeout(function() {
          return window.viewer.paint();
        }, 1);
      };
    })(this));
    $("table[class*=collection-details-datatable]").dataTable({
      sDom: "<'row-fluid'<'span6'l><'span6'f>r>t<'row-fluid'<'span6'i><'span6'p>>",
      sAjaxSource: "/api/collections/" + "{{ cid }}" + "/datatable/?format=json",
      iDisplayLength: 10
    });
    $("table[class*=collection-images-datatable]").dataTable({
      sDom: "<'row-fluid'<'span6'l><'span6'f>r>t<'row-fluid'<'span6'i><'span6'p>>",
      iDisplayLength: 10,
      aoColumns: [
        {
          sWidth: '7%'
        }, {
          sWidth: '43%'
        }, {
          sWidth: '12%'
        }, {
          sWidth: '15%'
        }, {
          sWidth: '23%'
        }
      ],
      fnRowCallback: function(nRow, aData, iDisplayIndex) {
        return nRow;
      }
    });
    $('#collection-tabs a:first').tab('show');
    $('#delete_collection').click(function(e) {
      return confirm("Are you sure you want to delete this collection? This operation cannot be undone!");
    });
    $('#upload_archive').click(function(e) {
      return document.getElementById("id_file").click();
    });
    $('#upload_folder').click(function(e) {
      return document.getElementById("folder_input").click();
    });
    $('#id_file').change(function(e) {
      return document.upload_folder_form.submit();
    });
    $('#folder_input').change(function(e) {
      uldata = e.target.files;
      return $('#upload_process').modal('show');
    });
    $("#upload_process").on("shown.bs.modal", function(e) {
      var csrftoken, data, files, i, paths, xhr;
      paths = "";
      files = uldata;
      xhr = new XMLHttpRequest();
      data = new FormData();
      for (i in files) {
        if (files[i].name !== void 0 && files[i].webkitRelativePath !== void 0) {
          if (files[i].name.indexOf(".") !== 0 && files[i].webkitRelativePath.indexOf('.files') === -1) {
            data.append('paths[]', files[i].webkitRelativePath);
            data.append('file_input[]', files[i]);
          }
        }
      }
      
      csrftoken = $.cookie('csrftoken');
      xhr.open('POST', "upload_folder", true);
      xhr.setRequestHeader("X-CSRFToken", csrftoken);
      xhr.onloadstart = function(e){
                $('.modal-backdrop').removeClass("modal-backdrop"); 
                showLoader();
      };
      
      // We need to know when the request finishes.
      xhr.onload = function (e) {
      if (xhr.status === 200) {
            hideLoader();
            return document.location = '';
          };
      }
      xhr.send(data);
      //return document.location = "";
    });
    if (navigator.userAgent.indexOf("Safari") > -1 && navigator.userAgent.indexOf("Chrome") === -1) {
      return $('a[href="pycortex"]').hide();
    }
  });

}).call(this);

</script>
{% endblock %}

{% block content %}
<div class="fade"></div>
<div class="row">
    <div class="col-md-12">
        <h2>{{ collection.name }}</h2>
        <p>Contributed by {{ collection.owner }}</p>
        {% if collection.authors %}
        <div class="lead">{{collection.authors}}</div>
        {% endif %}
        {% if collection.DOI %}
        <div class="lead"><a href="{{ collection.url }}">Link to the paper</a></div>
        {% endif %}
        {% if collection.full_dataset_url %}
        <div class="lead">Full dataset available at:<a href="{{ collection.full_dataset_url }}">
            {{ collection.full_dataset_url }}</a>
        </div>
        {% endif %}
        <div class="management-options">
            <form action="upload_folder" enctype="multipart/form-data" method= "POST" name="upload_folder_form">
            {% if collection.image_set.all %}
                <a class="btn.btn-primary" href="pycortex">3D View</a>
                {% if edit_permission %}
                <a class="btn.btn-primary" href="{% url 'add_image' cid %}">Add image</a>
                <div class="btn-group">
                    <a class="btn.btn-primary.dropdown-toggle" href= "#" data-toggle="dropdown">Edit</a>
                    <span class="caret"></span>
                    <ul class=dropdown-menu">
                        <a href="{% url 'edit_collection' cid %}">Collection Metadata</a>
                        {% if collection.image_set.all %}
                            {% if collection.is_statisticmap_set %}
                            <li><a href="{% url 'edit_metadata' cid %}">Images Metadata</a></li>
                            {% else %}
                            <li class="disabled"><a href="#">Images Metadata</a></li>
                            {% endif %}                  
                        {% endif %}
                    </ul>
                </div>
                <div class="btn-group">
                    <a href="btn.btn-primary.dropdown-toggle" href="#" data-toggle="dropdown">Upload</a>
                    <span class="caret"></span>
                    <ul clas="dropdown-menu">
                        <li><a id="upload_archive" href="#">Archive (.zip)</a></li>
                        <!--[if !IE]> -->                               
                        <li><a id="upload_folder" href="#">Folder</a></li>
                        <!-- <![endif]-->
                    </ul>                      
                </div>
                {% endif %}<!-- close edit permission -->
                {% if delete_permission %}
                <div class="float-right-wrapper">
                    <a class="btn.btn-danger" href="{% url 'delete_collection' cid %}" id="delete_collection"> Delete collection</a>
                </div>
                {% endif %}<!--close delete permission-->
                {% endif %}<!--close edit permission-->
                {% if collection.private %}
                <div class="lead">
                    <div style="font-size:16px; margin-top:20px;">
                        <em>Private Collection</em>: To share the link to this collection, please use the private url:
                                    <a href="{{ request.path }}">{{ request.path }}</a>
                                    {% csrf_token %}
                    </div>
                </div>
                {% endif %}
                <div style="height: 0px;width: 0px; overflow:hidden;">
                     {{ form.file }}
                     <input type="file" name="file_input[]" id="folder_input" multiple="" directory="" mozdirectory="" webkitdirectory=""></input>
                     <input type=hidden" name="paths" id="paths"></input>
                </div>
        </div><!-- close management options-->
          {% if messages %}
          <ul class="messages">
              {% for message in messages %}
              <div class="alert.alert-dismissible.alert-danger">
                <button class="close data-dismiss alert" type="button">Ã— {{ message }}</button>
              </div>
              {% endfor %}
          </div>
          {% endif %}
          <ul id='collection-tabs' class='nav nav-tabs'>
              <li><a data-toggle='tab' href='#images'>Images</a></li>
              <li><a data-toggle='tab' href='#details'>Details</a></li>
          </ul>
          <div class='tab-content'>
              <div id='images' class='tab-pane active'>
              {% if collection.image_set.all or not edit_permission %}
                  <table class='table table-striped table-hover collection-images-datatable'>
                  <thead>
                      <tr>
                          <th>ID</th>
                          <th>Name</th>
                          <th>Tags</th>
                          <th>Type</th>
                          <th>Description</th>
                      </tr>
                  </thead>
                  <tbody>
                  {% for image in images %}
	              <tr>
	                  <td>{{image.id}}</td>
	                  <td>{% if image.zip_name %}
                              <a href="{{image.nidm_results.get_absolute_url}}">
                                  {{image.nidm_results.name}}&nbsp;<i class="icon-double-angle-right"></i>&nbsp;
	                      <a href="{{image.get_absolute_url}}">{{ image.name }}
	                          {% else %}
                                  <a href="{{image.get_absolute_url}}">{{ image.name }}</a>
                                  {% endif %}
	                  </td>
                          <td>
	                  {% for tag in image.tags.all %}
                              <a href="/images/tags/{{tag.name}}">{{ tag.name }}
	                      {% if not forloop.last %}
	                          {{ image.polymorphic_ctype.name }}
	                      {% endif %}
	                      {% if image.zip_name %}
                              NIDMResults:
	                      <a href="{{image.nidm_results.zip_file.url}}">{{image.nidm_results.name}}.zip</a>
	                      {% else %}
	                      {{image.description}}
                              {% endif %}
                          {% endfor %}
                          </td>
                     </tr>
                   {% endfor %}
                   </tbody>
                </table>
                {% else %}
                <div class="light-head center-text">
                    This collection is empty. You can:
                    <br><br>
                        <a class="btn btn-lg btn-primary" href="{% url 'add_image' cid %}">Add images one by one</a>
                        <a id="upload_archive" class="btn btn-lg btn-primary" href="#">Upload an archive with images (.zip or .tar.gz)</a>
                        <!--[if !IE]> -->
                        <a id="upload_folder" class="btn btn-lg btn-primary" href="#">Upload a folder with images</a>
                        <!-- <![endif]-->
                    </div>
              {% endif %}
              </div><!-- Close images tab-->  
              <div id="details" class="tab-pane">
                  {% if  collection.image_set.all %}
                  <table class='table table-condensed table-striped table-hover collection-details-datatable'>
                  <thead>
                      <tr>
                          <th>Field</th>
                          <th>Value</th>
                      </tr>
                  </thead>
                  <tbody> <!-- NEED TO REDO THIS-->
                  {% endif %}
              </div><!-- close details tab-->
              <div id="viewer" class="tab-pane">
                     {% include 'statmaps/_neurosynth_viewer_content.html.haml' %}
              </div>
              <div id="upload_process" class="modal" style="margin-top: 175px;" data-keyboard="false"></div>               
         </div><!-- close tab content-->
    </div><!-- column-->
</div><!--row-->

<div id='spinny' class='modal neuron_loader' style='margin-top: 175px; left:45%; top:15%' data-keyboard='false'>
     <img src="{% static "images/spinner.gif"%}"/>
</div><!-- close spinner-->

{% comment %}
{% for image in collection.image_set.all %}
    <li><a href="{% url 'image_details' image.id %}">{{ image.name }}</a></li>
{% endfor %}
<a href="{{collection.url}}">{{collection.name}}</a> by {{collection.authors}}
<a href="{% url 'edit_images' cid %}">Add/edit files</a>
{% endcomment %}
{% endblock %}
